<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible"
        content="ie=edge">
  <title> Title </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.1/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.min.js"></script>
  <link rel="stylesheet"
        href="Jablonski.css">

</head>

<body onload="init()">
  <div id="applet_container">
    <div id="container_wrapper">
      <div id="canvas_container"></div>
    </div>
    <div id="menu_container">
      <div id="form_container">
        <h2>Das Jablonski-Diagramm</h2>
        <p>Hier steht ein Text zum Jablonski-Diagramm, ich bin jedoch noch nicht sicher, welche Informationen sinnvoll sind.</p>
        <form id="input_form">
          <label for="fluorophores"
                 id="fluor-select_legend">Welcher Fluorophor soll dargestellt werden?</label>
          <select name="fluorophores"
                  id="fluorophore_select"
                  onchange="changeFluorophore(this)">
              <option value="TexasRed">TexasRed</option>
              <option value="Atto488">Atto488</option>
              <option value="YFP">YFP</option>
              <option value="DAPI">DAPI</option>
          </select>
          <fieldset id="transition_selection">
            <legend>Welcher Strahlungs√ºbergang soll dargestellt werden?</legend>
            <ul>
              <li>
                <input type="radio"
                       checked
                       id="fluorescence"
                       name="transition"
                       value="fluorescence">
                <label for="fluorescence">Fluoreszenz</label>
              </li>
              <li>
                <input type="radio"
                       id="phosphorescence"
                       name="transition"
                       value="phosphorescence">
                <label for="phosphorescence">Phosphoreszenz</label>
              </li>
            </ul>
          </fieldset>
        </form>
      </div>
      <div id="structure_container"></div>
    </div>
  </div>

  <script>
    "use strict";

    var colorChange = 0xff0000;

    function changeFluorophore(select) {
      switch (select.value) {
        case "TexasRed":
          colorChange = 0xff0731;
          break;
        case "DAPI":
          colorChange = 0x0900ff;
          break;
        case "Atto488":
          colorChange = 0x39ff14;
          break;
        case "YFP":
          colorChange = 0xffff00;
          break;
      }
    }


    var Application = PIXI.Application,
      loader = PIXI.loader,
      resources = PIXI.loader.resources,
      Sprite = PIXI.Sprite,
      TextureCache = PIXI.utils.TextureCache,
      Rectangle = PIXI.Rectangle,
      Container = PIXI.Container,
      Graphics = PIXI.Graphics,
      AnimatedSprite = PIXI.extras.AnimatedSprite,
      Text = PIXI.Text;

    var photonAnimation;
    var canvas, photon;
    var drag = false,
      tweening = false;
    var startpos;
    var s1_bars, s0_bars, t1_bars, electron;
    var interaction;
    var startWidth = 800;
    var startHeight = 600;
    var scale;
    var s1_text, s0_text, t1_text;

    var app = new Application({
      resolution: devicePixelRatio,
      width: startWidth,
      height: startHeight,
      autoResize: true,
      transparent: false,
      antialias: true,
      backgroundColor: 0xffffff,
    });
    app.stage.interactive = true;
    interaction = app.renderer.plugins.interaction;

    document
      .querySelector("#canvas_container")
      .appendChild(app.view);
    window.addEventListener("resize", resize);

    function init() {
      loader
        .add([
          "photon_sprites.json",
          "Elektron.png",
          "Laser.png",
          "Auge.png"
        ])
        .load(setup);

      s0_bars = new Bars(5, 350, 475, 400, 2.5, 1.25, 6);

      s1_bars = new Bars(5, 375, 100, 150, 2.5, 1.25, 6);
      t1_bars = new Bars(5, 575, 200, 150, 2.5, 1.25, 6);

      s1_text = new Text("S1", {
        fontFamily: 'Arial Black',
        fontSize: 25,
        align: 'center'
      });
      s1_text.anchor.set(0.5, 0.5);
      s1_text.position.set(s1_bars.container.x - 25, s1_bars.container.y + s1_bars.container.height / 2);

      s0_text = new Text("S0", {
        fontFamily: 'Arial Black',
        fontSize: 25,
        align: 'center'
      });
      s0_text.anchor.set(0.5, 0.5);
      s0_text.position.set(s0_bars.container.x - 25, s0_bars.container.y + s0_bars.container.height / 2);

      t1_text = new Text("T1", {
        fontFamily: 'Arial Black',
        fontSize: 25,
        align: 'center'
      });
      t1_text.anchor.set(0.5, 0.5);
      t1_text.position.set(t1_bars.container.x - 25, t1_bars.container.y + t1_bars.container.height / 2);

      app
        .stage
        .addChild(s1_text, s0_text, t1_text, s1_bars.container, s0_bars.container, t1_bars.container);

      app.ticker.add(function() {
        TWEEN.update();
      });
    }

    function setup() {
      var frames = [];

      for (var i = 1; i <= 8; i++) {
        frames.push(PIXI.Texture.fromFrame("photon-sprite_fr" + i + ".png"));
      }

      resources

      photon = new AnimatedSprite(frames, true);
      app.stage.addChild(photon);
      photon.alpha = 0;
      photon.scale.set(0.1);
      photon.anchor.set(0, 0.5);
      photon.animationSpeed = 0.3;
      photon.rotation = Math.PI * 14 / 8;

      var laser = new Sprite(resources["Laser.png"].texture);
      laser.scale.set(0.125, 0.125);
      laser.anchor.set(0.5, 0.5);
      laser.position.y = s0_bars.getLastChild().getGlobalPosition().y / scale;
      laser.position.x = 100;

      var auge = new Sprite(resources["Auge.png"].texture);
      auge.scale.set(0.1, 0.1);
      auge.anchor.set(0.5, 0.5);
      auge.position.set(100, 200);

      electron = new Sprite(resources["Elektron.png"].texture);
      electron.anchor.set(0.5, 0.5);
      electron.position = toGlobal(s0_bars.getLastChild());
      electron.scale.set(0.05, 0.05);
      makeDraggable(electron);

      app.stage.addChild(auge, laser, electron);
    }

    function Bars(amount, posX, posY, width, height, radius, step) {
      this.container = new Container();
      this.getFirstChild = function() {
        return this.container.children[0];
      };
      this.getLastChild = function() {
        return this.container.children[this.container.children.length - 1];
      };
      this.getBars = function() {
        return this.container.children;
      };

      var margin = 1.2;
      var bar;
      for (var i = 0; i < amount; i++) {

        bar = new Graphics()
          .beginFill()
          .drawRoundedRect(0, 0, width, height, radius)
          .endFill();

        bar.pivot.x = bar.width / 2;
        bar.pivot.y = bar.height / 2;
        bar.hitArea = new Rectangle(0, -height * margin / 2, width, height * (1 + margin));

        bar.y = step * Math.pow(i, 1.9) + bar.pivot.y;
        bar.x = 0 + bar.pivot.x;

        bar.interactive = true;
        this.container.addChild(bar);
      }
      this.container.x = posX;
      this.container.y = posY;
    };

    function makeDraggable(target) {
      var scaling = function() {
        var barHeight = 2.5;

        return {
          scaleUp: function(bar) {
            new TWEEN.Tween(bar).to({
              height: barHeight * 2,
            }, 100).start();
          },
          scaleDown: function(bar) {
            new TWEEN.Tween(bar).to({
              height: barHeight,
            }, 100).start();
          },
        };
      }();

      target.interactive = true;
      target.on("mousedown", function(e) {
        if (!tweening) {
          drag = target;
        }
      })
      target.on("mouseup", function(e) {
        drag = false;

        target.x = s0_bars.getLastChild()
          .getGlobalPosition().x / scale;
        target.y = s0_bars.getLastChild()
          .getGlobalPosition().y / scale;

        var hit = interaction.hitTest(e.data.global, s1_bars.container);
        if (hit) {
          target.x = hit.getGlobalPosition().x / scale;
          target.y = hit.getGlobalPosition().y / scale;
          scaling.scaleDown(hit);
          phosRelax(hit);
        }
      })
      target.on("mousemove", function(e) {
        if (drag) {
          drag.position.x = e.data.global.x / scale;
          drag.position.y = e.data.global.y / scale;
          var hit = interaction.hitTest(e.data.global, s1_bars.container);
          if (hit) {
            scaling.scaleUp(hit);
          }
          s1_bars.getBars().forEach(function(bar) {
            if (bar != hit) {
              scaling.scaleDown(bar);
            }
          });

        }
      });
    }

    function photonAnimation(start_pos, end_pos, duration) {
      var x_sign, y_sign;

      photon.position.set(start_pos.x, start_pos.y);
      photon.play();

      var x_dist = end_pos.x - start_pos.x;
      var y_dist = end_pos.y - start_pos.y;

      x_sign = x_dist < 0 ? "" : "+";
      y_sign = y_dist < 0 ? "" : "+";

      var first = new TWEEN.Tween(photon).to({
        x: x_sign + x_dist / 3,
        y: y_sign + y_dist / 3,
        alpha: 1,
      }, duration / 3);
      var second = new TWEEN.Tween(photon).to({
        x: x_sign + x_dist / 3,
        y: y_sign + y_dist / 3,
      }, duration / 3);
      var third = new TWEEN.Tween(photon).to({
        x: x_sign + x_dist / 3,
        y: y_sign + y_dist / 3,
        alpha: 0,
      }, duration / 3);

      first.chain(second.chain(third));
      first.start();
    }

    function createTween(object, start_pos, end_pos, duration, delay, easing) {
      if (duration == null) {
        duration = 1000;
      }
      if (delay == null) {
        delay = 500;
      }
      if (easing == null) {
        easing = TWEEN.Easing.Sinusoidal.InOut;
      }
      var x_dist = end_pos.x - start_pos.x;
      var y_dist = end_pos.y - start_pos.y;

      var x_sign = x_dist < 0 ? "" : "+";
      var y_sign = y_dist < 0 ? "" : "+";

      return new TWEEN.Tween(object).to({
          x: x_sign + x_dist,
          y: y_sign + y_dist,
        }, duration)
        .easing(easing).delay(delay);
    }

    function EmmissionTweens(object, start_pos, end_pos, duration, delay) {
      this.tweens = [];
      this.getFirstTween = function() {
        return this.tweens[0];
      };
      this.getLastTween = function() {
        return this.tweens[this.tweens.length - 1];
      };

      if (duration == null) {
        duration = 1000;
      }
      if (delay == null) {
        delay = 500;
      }

      var mid_pos = {
        x: start_pos.x + (end_pos.x - start_pos.x) / 2,
        y: start_pos.y + (end_pos.y - start_pos.y) / 2,
      };

      this.tweens.push(createTween(object, start_pos, mid_pos, duration / 2, delay, TWEEN.Easing.Sinusoidal.In));
      this.tweens.push(createTween(object, mid_pos, end_pos,
        duration / 2, 0, TWEEN.Easing.Sinusoidal.Out));

      this.tweens[0].chain(this.tweens[1]);
      this.tweens[0].onComplete(function() {
        photonAnimation(mid_pos, {
          x: mid_pos.x + 100,
          y: mid_pos.y - 100,
        }, 5000)
      });
    }

    function BarTweens(startBar, bars) {
      this.tweens = [];
      this.positions = [];
      this.getFirstTween = function() {
        return this.tweens[0];
      };
      this.getLastTween = function() {
        return this.tweens[this.tweens.length - 1];
      };

      bars
        .slice(bars.indexOf(startBar))
        .forEach(function(bar, i, barArr) {
          if (i < barArr.length - 1) {
            var nextBar = barArr[i + 1];
            this.tweens.push(createTween(electron, bar.position, nextBar.position));
          }
        }, this);

      this.tweens.forEach(function(tween, i, tweenArr) {
        if (i < tweenArr.length - 1) {
          tween.chain(tweenArr[i + 1]);
        }
      })
    }

    function fluorRelax(bar) {
      var startTween;

      var highTweens = new BarTweens(bar, s1_bars.getBars());

      var randBar = s0_bars.getBars()[Math.floor(Math.random() * s0_bars.getBars().length)]; //select a random bar from the lowBars

      var emisTweens = new EmmissionTweens(electron, {
        x: s1_bars.getLastChild().getGlobalPosition().x / scale,
        y: s1_bars.getLastChild().getGlobalPosition().y / scale,
      }, {
        x: randBar.getGlobalPosition().x / scale,
        y: randBar.getGlobalPosition().y / scale,
      }, 3000);

      var lowTweens = new BarTweens(randBar, s0_bars.getBars());

      if (highTweens.getLastTween() != null) {
        highTweens.getLastTween().chain(emisTweens.getFirstTween());
        startTween = highTweens.getFirstTween();
      } else {
        startTween = emisTweens.getFirstTween();
      }

      emisTweens.getLastTween().chain(lowTweens.getFirstTween());

      tweening = true;
      console.log(lowTweens);
      lowTweens.getLastTween().onComplete(function() {
        tweening = false;
      })
      startTween.start();
    }

    function phosRelax(bar) {
      var startTween;

      var s1_tweens = new BarTweens(bar, s1_bars.getBars());

      var rand_t1 = t1_bars.getBars()[Math.floor(Math.random() * t1_bars.getBars().length)]; //select a random bar from the t1_bars

      var s1_t1_tween = createTween(electron, toGlobal(s1_bars.getLastChild()), toGlobal(rand_t1));

      var t1_tweens = new BarTweens(rand_t1, t1_bars.getBars());

      var rand_s0 = s0_bars.getBars()[Math.floor(Math.random() * s0_bars.getBars().length)]; //select a random bar from the s0_bars

      var t1_s0_tweens = new EmmissionTweens(electron, toGlobal(t1_bars.getLastChild()), toGlobal(rand_s0), 3000);

      var s0_tweens = new BarTweens(rand_s0, s0_bars.getBars());

      if (s1_tweens.getLastTween() == null) {
        startTween = s1_t1_tween;
      } else {
        startTween = s1_tweens.getFirstTween();
        s1_tweens.getLastTween().chain(s1_t1_tween);
      }

      if (t1_tweens.getLastTween() == null) {
        s1_t1_tween.chain(t1_s0_tweens.getFirstTween());
      } else {
        s1_t1_tween.chain(t1_tweens.getFirstTween());
        t1_tweens.getLastTween().chain(t1_s0_tweens.getFirstTween());
      }
      t1_s0_tweens.getLastTween().chain(s0_tweens.getFirstTween());

      startTween.start();
    }

    function toGlobal(bar) {
      var pos = bar.getGlobalPosition();
      return {
        x: pos.x / scale,
        y: pos.y / scale,
      }
    }

    function resize() {
      var parent = app.view.parentNode;

      app.renderer.resize(parent.clientWidth, parent.clientHeight);

      scale = parent.clientWidth / startWidth;
      app.stage.scale.set(scale, scale);
    }

    resize();
  </script>
</body>

</html>
