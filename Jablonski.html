<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible"
        content="ie=edge">
  <title> Title </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.1/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.min.js"></script>
  <link rel="stylesheet"
        href="Jablonski.css">

</head>

<body onload="init()">
  <div id="applet_container">
    <div id="container_wrapper">
      <div id="canvas_container"></div>
    </div>
    <div id="menu_container">
      <div id="form_container">
        <h2>Das Jablonski-Diagramm</h2>
        <p>Hier steht ein Text zum Jablonski-Diagramm, ich bin jedoch noch nicht sicher, welche Informationen sinnvoll sind.</p>
        <form id="input_form">
          <label for="fluorophores"
                 id="fluor-select_legend">Welcher Fluorophor soll dargestellt werden?</label>
          <select name="fluorophores"
                  id="fluorophore_select"
                  onchange="changeFluorophore(this)">
              <option value="TexasRed">TexasRed</option>
              <option value="Atto488">Atto488</option>
              <option value="YFP">YFP</option>
              <option value="DAPI">DAPI</option>
          </select>
          <fieldset id="transition_selection">
            <legend>Welcher Strahlungs√ºbergang soll dargestellt werden?</legend>
            <ul>
              <li>
                <input type="radio"
                       checked
                       id="fluorescence"
                       name="transition"
                       value="fluorescence">
                <label for="fluorescence">Fluoreszenz</label>
              </li>
              <li>
                <input type="radio"
                       id="phosphorescence"
                       name="transition"
                       value="phosphorescence">
                <label for="phosphorescence">Phosphoreszenz</label>
              </li>
            </ul>
          </fieldset>
        </form>
      </div>
      <div id="structure_container"></div>
    </div>
  </div>

  <script>
    "use strict";

    var colorChange = 0xff0000;

    function changeFluorophore(select) {
      switch (select.value) {
        case "TexasRed":
          colorChange = 0xff0731;
          break;
        case "DAPI":
          colorChange = 0x0900ff;
          break;
        case "Atto488":
          colorChange = 0x39ff14;
          break;
        case "YFP":
          colorChange = 0xffff00;
          break;
      }
    }


    var Application = PIXI.Application,
      loader = PIXI.loader,
      resources = PIXI.loader.resources,
      Sprite = PIXI.Sprite,
      TextureCache = PIXI.utils.TextureCache,
      Rectangle = PIXI.Rectangle,
      Container = PIXI.Container,
      Graphics = PIXI.Graphics,
      AnimatedSprite = PIXI.extras.AnimatedSprite,
      Text = PIXI.Text;

    var photonAnimation;
    var canvas, photon, photon;
    var drag = false;
    var startpos;
    var highBars, lowBars, tempBars, electron;
    var allBars, interaction;
    var barHeight = 2.5;
    var startWidth = 800;
    var startHeight = 600;
    var scale;
    var S1_text, S0_text, T1_text;

    var app = new Application({
      resolution: devicePixelRatio,
      width: startWidth,
      height: startHeight,
      autoResize: true,
      transparent: false,
      antialias: true,
      backgroundColor: 0xffffff,
    });
    app.stage.interactive = true;
    interaction = app.renderer.plugins.interaction;

    document
      .querySelector("#canvas_container")
      .appendChild(app.view);
    window.addEventListener("resize", resize);

    function init() {
      loader
        .add("photon_sprites.json")
        .load(setup);

      lowBars = new Bars(5, 100, 400, 225, 2.5, 1.25, 6);

      highBars = new Bars(5, 100, 100, 225, 2.5, 1.25, 6);
      tempBars = new Bars(5, 450, 200, 225, 2.5, 1.25, 6);

      S1_text = new Text("S1", {
        fontFamily: 'Arial Black',
        fontSize: 25,
        align: 'center'
      });
      S1_text.anchor.set(0.5, 0.5);
      S1_text.position.set(highBars.x - 25, highBars.y + highBars.height / 2);

      S0_text = new Text("S0", {
        fontFamily: 'Arial Black',
        fontSize: 25,
        align: 'center'
      });
      S0_text.anchor.set(0.5, 0.5);
      S0_text.position.set(lowBars.x - 25, lowBars.y + lowBars.height / 2);

      T1_text = new Text("T1", {
        fontFamily: 'Arial Black',
        fontSize: 25,
        align: 'center'
      });
      T1_text.anchor.set(0.5, 0.5);
      T1_text.position.set(tempBars.x - 25, tempBars.y + tempBars.height / 2);

      allBars = [highBars, lowBars, tempBars];

      electron = new Graphics()
        .beginFill(0x521515)
        .drawCircle(0, 0, 10);

      electron.x = lowBars.getLastChild().getGlobalPosition().x;
      electron.y = lowBars.getLastChild().getGlobalPosition().y;
      app
        .stage
        .addChild(S1_text, S0_text, T1_text, highBars.getContainer(), lowBars.getContainer(), tempBars.getContainer(), electron);

      makeDraggable(electron);

      app.ticker.add(function() {
        TWEEN.update();
      });
    }

    function setup() {
      var frames = [];

      for (var i = 1; i <= 8; i++) {
        frames.push(PIXI.Texture.fromFrame("photon-sprite_fr" + i + ".png"));
      }

      photon = new AnimatedSprite(frames, true);
      app.stage.addChild(photon);
      photon.alpha = 0;
      photon.scale.set(0.1);
      photon.anchor.set(0, 0.5);
      photon.animationSpeed = 0.3;
      photon.rotation = Math.PI * 14 / 8;
    }

    function Bars(amount, posX, posY, width, height, radius, step) {
      var margin = 1.2;
      this.container = new Container();
      (function() {
        for (var i = 0; i < amount; i++) {

          var bar = new Graphics()
            .beginFill()
            .drawRoundedRect(0, 0, width, height, radius)
            .endFill();

          bar.pivot.x = bar.width / 2;
          bar.pivot.y = bar.height / 2;
          bar.hitArea = new Rectangle(0, -height * margin / 2, width, height * (1 + margin));

          bar.y = step * Math.pow(i, 1.9) + bar.pivot.y;
          bar.x = 0 + bar.pivot.x;

          bar.interactive = true;
          bars.addChild(bar);
        }
        bars.x = posX;
        bars.y = posY;
      })();
      this.getFirstChild = function() {
        return bars.children[0];
      };
      this.getLastChild = function() {
        return bars.children[bars.children.length - 1];
      };
      this.getBars = function() {
        return bars.children;
      };
    };

    function mouseOut(event) {
      event.currentTarget.scale.set(1, 1);
    };

    function makeDraggable(target) {
      var startpos;
      target.interactive = true;
      target.on("mousedown", function(e) {
        startpos = {
          x: target.x,
          y: target.y,
        }
        drag = target;
      })
      target.on("mouseup", function(e) {
        drag = false;

        target.x = startpos.x;
        target.y = startpos.y;

        var hit = interaction.hitTest(e.data.global, highBars);
        if (hit) {
          target.x = hit.getGlobalPosition().x / scale;
          target.y = hit.getGlobalPosition().y / scale;
          outBars(hit);
          relaxateElectron(hit);
        }
      })
      target.on("mousemove", function(e) {
        if (drag) {
          drag.position.x = e.data.global.x / scale;
          drag.position.y = e.data.global.y / scale;
          var hit = interaction.hitTest(e.data.global, highBars);
          if (hit) {
            overBars(hit);
          }
          highBars.children.forEach(function(bar) {
            if (bar != hit) {
              outBars(bar);
            }
          });

        }
      });
    }

    function overBars(bar) {
      new TWEEN.Tween(bar).to({
        height: barHeight * 2,
      }, 100).start();
    };

    function outBars(bar) {
      new TWEEN.Tween(bar).to({
        height: barHeight,
      }, 100).start();
    }

    function photonAnimation() {
      photon.position.set(electron.x, electron.y);
      photon.play();
      var first = new TWEEN.Tween(photon).to({
        x: "+20",
        y: "-20",
        alpha: 1,
      }, 1000);
      var second = new TWEEN.Tween(photon).to({
        x: "+20",
        y: "-20",
      }, 1000);
      var third = new TWEEN.Tween(photon).to({
        x: "+20",
        y: "-20",
        alpha: 0,
      }, 1000);

      first.chain(second.chain(third));
      return first.start();
    }

    function relaxateElectron(bar) {

      function randomRelexation(bar, lowBars, i) {
        var distance = (lowBars[i].getGlobalPosition().y - bar.getGlobalPosition().y) / scale;
        var tweens = [];

        tweens[0] = new TWEEN.Tween(electron).to({
            y: "+" + distance / 2,
          }, 3000)
          .easing(TWEEN.Easing.Sinusoidal.In)
          .delay(500)
          .onComplete(photonAnimation);

        tweens[1] = new TWEEN.Tween(electron).to({
            y: "+" + distance / 2,
          }, 3000)
          .easing(TWEEN.Easing.Sinusoidal.Out);

        tweens[0].chain(tweens[1]);


        return tweens;
      }

      var highTweens = createBarTweens(bar, highbars.children);

      var randI = Math.floor(Math.random() * lowBars.children.length);
      var randTweens = randomRelexation(highbars.children[highbars.children.length - 1], lowBars.children, randI);
      randTweens[0].onStart(function() {
        app.renderer.backgroundColor = colorChange;
      })
      randTweens[1].onComplete(function() {
        app.renderer.backgroundColor = 0xffffff;
      })

      var lowTweens = createBarTweens(lowBars.children[randI], lowBars.children);

      var firstTween;

      if (highTweens != null && highTweens.length != 0) {
        firstTween = chain(highTweens, randTweens);
      } else {
        firstTween = randTweens[0];
      }

      if (lowTweens != null && lowTweens.length != 0) {
        chain(randTweens, lowTweens);
      }

      firstTween.start();

    }

    function chain(firstTweens, secondTweens) {
      if (Array.isArray(firstTweens)) {
        if (Array.isArray(secondTweens)) {
          firstTweens[firstTweens.length - 1].chain(secondTweens[0]);
          return firstTweens[0];
        } else {
          firstTweens[firstTweens.length - 1].chain(secondTweens);
          return firstTweens[0];
        }
      } else {
        if (Array.isArray(secondTweens)) {
          firstTweens.chain(secondTweens[0]);
          return firstTweens;
        } else {
          firstTweens.chain(secondTweens);
          return firstTweens;
        }
      }
    }

    function createBarTweens(startBar, bars) {
      var tweenChain;
      var distances;

      distances = bars
        .slice(bars.indexOf(startBar))
        .map(function(bars, i, barArray) {
          if (i + 1 < barArray.length) {
            return barArray[i + 1].y - barArray[i].y;
          }
        });
      distances.pop();

      tweenChain = distances.map(function(distance) {
        return new TWEEN.Tween(electron)
          .to({
            y: "+" + distance
          }, 1000).easing(TWEEN.Easing.Sinusoidal.InOut).delay(500);
      });

      tweenChain.forEach(function(tween, index, tweens) {
        if (index + 1 < tweens.length) {
          tweens[index] = tween.chain(tweens[index + 1]);
        }
      });

      return tweenChain;
    }

    function resize() {
      var parent = app.view.parentNode;

      app.renderer.resize(parent.clientWidth, parent.clientHeight);

      scale = parent.clientWidth / startWidth;
      app.stage.scale.set(scale, scale);
    }

    resize();
  </script>
</body>

</html>
